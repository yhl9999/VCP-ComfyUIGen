# ComfyUI 插件说明文档

## 功能介绍

ComfyUIGen 是一个VCP插件，用于通过ComfyUI API生成图像。插件支持多种部署方式：

- **本地部署**: `http://localhost:8188`
- **VSCode端口转发**: `http://localhost:8188` (或其他端口)
- **云服务器**: 自定义URL

## 前端集成功能 (2025-01-30 更新)

### VCPChat 独立模块集成

为了更好的模块化架构和用户体验，ComfyUI已完全从VCPChat全局设置中解耦，实现为独立模块：

#### 1. 独立模块架构 ✅
**参照设计**: 遵循Notemodules模块化设计模式

**核心文件结构**:
```
D:\vcp\VCPChat\ComfyUImodules\
├── comfyui-settings.html     # 独立配置界面
├── comfyui-settings.css      # 专业UI样式
└── comfyui-settings.js       # 完整前端逻辑
```

**功能特性**:
- **完整独立界面**: 专业的配置管理界面，包含所有ComfyUI参数
- **模型管理**: 支持模型和LoRA的选择，带搜索和筛选功能
- **连接测试**: 实时测试ComfyUI服务器连接状态
- **工作流选择**: 动态加载和选择工作流模板
- **参数配置**: 完整的生成参数设置（采样器、尺寸、种子等）

#### 2. 系统集成实现
**文件修改**: `D:\vcp\VCPChat\main.js`
- 行31: 导入ComfyUI处理器模块
- 行59: 声明comfyuiWindow变量
- 行517-583: 实现完整的窗口管理器（创建、显示、关闭、生命周期）

**文件修改**: `D:\vcp\VCPChat\preload.js`
- 行238: 添加`openComfyUIWindow` IPC接口

**文件修改**: `D:\vcp\VCPChat\renderer.js`
- 行1324-1333: 添加ComfyUI按钮事件处理

**文件修改**: `D:\vcp\VCPChat\main.html`
- 在notes-section区域添加ComfyUI按钮，使用🎨画笔图标
- 与笔记、音乐、翻译、骰子等模块按钮保持一致的设计风格

#### 3. 后端处理器
**文件**: `D:\vcp\VCPChat\modules\ipc\comfyuiHandlers.js`

实现了完整的后端处理逻辑：
- ComfyUI服务器连接管理
- 独立配置文件管理（comfyui-settings.json）
- 模型和LoRA列表获取
- 双重HTTP客户端（axios + 原生HTTP）容错机制
- 完整的错误处理和状态反馈

**默认配置**:
```javascript
const defaultComfyUIConfig = {
    seed: 156680208700286,
    steps: 20,
    cfg_scale: 7,
    sampler_name: 'euler',
    scheduler: 'normal',
    width: 1024,
    height: 1024,
    MODEL_NAME: 'v1-5-pruned-emaonly.ckpt',
    negative_prompt: 'lowres, bad anatomy, bad hands, text, error...'
};
```

#### 4. 架构一致性验证

**与现有模块对比**:
| 功能 | 笔记模块 | 翻译模块 | ComfyUI模块 |  
|------|----------|----------|-------------|
| 独立目录 | Notemodules | Translatormodules | ComfyUImodules ✅ |
| 窗口处理 | notes handlers | translator window | comfyui window ✅ |
| IPC接口 | openNotesWindow | openTranslatorWindow | openComfyUIWindow ✅ |
| 按钮事件 | openNotesBtn | openTranslatorBtn | openComfyUIBtn ✅ |

**完全解耦成果**:
- ✅ 所有ComfyUI功能已从VCPChat全局设置完全移除
- ✅ 独立配置系统，不依赖VCPChat的settings.json
- ✅ 模块化窗口管理，遵循VCP标准架构
- ✅ 完整的IPC通信链：按钮 → 渲染进程 → 预加载 → 主进程 → 窗口

### 占位符处理系统

**现有文件**: `D:\vcp\VCPToolBox\Plugin\ComfyUIGen\placeholder-processor.js`

该系统已完整实现：
- 占位符提取和分类（Agent生成 vs 用户配置）
- 参数验证框架
- 多API格式转换支持
- 前端配置模板生成

### 工作流程设计

1. **独立模块配置**: 用户通过ComfyUI独立窗口配置所有生成参数
2. **Agent提示词生成**: Agent通过系统提示词生成图像描述prompt
3. **参数整合**: 后端结合独立配置和Agent生成的prompt
4. **占位符替换**: 使用placeholder-processor.js替换工作流中的占位符
5. **ComfyUI调用**: 发送完整工作流给ComfyUI服务器生成图像

## 系统设计和工作流程

### 🎯 **优化的Agent-ComfyUI协作模式**

#### 工作原理
1. **Agent职责**: 专注于创意，根据用户需求和上下文生成高质量的正面提示词
2. **用户配置**: 通过ComfyUI独立模块设置所有技术参数（模型、LoRA、尺寸、采样器等）
3. **后端整合**: 自动合并Agent的创意提示词和用户的技术配置，生成最终图像

#### 调用方式
Agent只需提供**prompt**（正面提示词），所有技术参数由用户预先配置：

```
<<<[TOOL_REQUEST]>>>
tool_name:「始」ComfyUIGen「末」,
prompt:「始」a majestic dragon soaring through cloudy skies, highly detailed fantasy art, epic scene「末」
<<<[END_TOOL_REQUEST]>>>
```

#### 配置优先级
1. **Agent输入参数** (最高优先级) - prompt、negative_prompt等
2. **用户前端配置** (comfyui-settings.json) - 模型、LoRA、尺寸、采样器等
3. **环境配置** (config.env) - 服务器地址、API密钥等
4. **系统默认值** (最低优先级) - 基础兜底参数

### ✅ **前后端配置链路集成 (已完成)**

#### 集成成果 
经过完整的系统重构，现已实现了以下功能：

**独立模块架构**
- ✅ 完全从VCPChat全局设置中解耦ComfyUI功能
- ✅ 创建独立的ComfyUImodules目录和完整界面
- ✅ 实现模块化窗口管理，参照Notemodules设计模式
- ✅ 添加专业的配置界面，包含测试连接、模型选择、参数调节等功能

**后端配置集成**
- ✅ 修改ComfyUIGen.js读取comfyui-settings.json配置文件
- ✅ 实现config.env + comfyui-settings.json的优先级配置机制
- ✅ 集成placeholder-processor.js到主生成流程
- ✅ 建立统一的参数验证和转换系统

**LoRA支持实现**
- ✅ 扩展默认工作流包含LoRA加载节点
- ✅ 修改updateWorkflowWithParams函数支持LoRA参数
- ✅ 实现LoRA模型文件路径的正确应用
- ✅ 添加LoRA强度参数控制

**工作流管理系统**
- ✅ 实现动态工作流模板加载
- ✅ 支持用户自定义工作流上传
- ✅ 工作流参数验证和占位符处理
- ✅ 工作流兼容性检查机制

#### 预期成果（全部实现）
- ✅ 独立模块配置完全生效到后端生成过程  
- ✅ 用户选择的模型、LoRA、参数正确应用
- ✅ 支持多种工作流模板选择
- ✅ 统一的参数验证和错误处理
- ✅ 完整的配置优先级：用户设置 > config.env > 系统默认
- ✅ 架构解耦完成，ComfyUI功能完全独立于VCPChat核心

## 待实现功能和扩展计划

### 🔧 其他计划功能

#### 工作流扩展支持
- [ ] img2img工作流模板
- [ ] inpainting工作流模板  
- [ ] controlNet工作流支持
- [ ] 批量生成模式

#### 高级参数支持
- [ ] LoRA强度参数调节
- [ ] 多LoRA模型混合
- [ ] 高级采样器参数
- [ ] 自定义VAE支持

#### 性能和稳定性
- [ ] 生成任务队列管理
- [ ] 断点续传支持
- [ ] 网络请求重试机制
- [ ] 内存使用优化

## 安装步骤

1. **创建配置文件**:
   ```bash
   cp config.env.example config.env
   ```

2. **编辑配置**:
   ```bash
   # 修改 config.env 中的 ComfyUI 地址
   COMFYUI_BASE_URL=http://localhost:8188
   ```

3. **安装依赖**:
   ```bash
   npm install axios uuid
   ```

4. **确保ComfyUI运行**:
   - 启动ComfyUI并确保API可访问
   - 默认端口为8188

5. **前端配置**:
   - 在VCPChat主界面点击ComfyUI按钮（🎨图标）
   - 在独立配置窗口中设置服务器地址和参数
   - 选择模型、LoRA和工作流模板
   - 测试连接确保正常

## 使用方法

### 🔧 独立模块配置（一次性设置）
1. 在VCPChat主界面点击ComfyUI按钮（🎨图标）
2. 在打开的独立配置窗口中：
   - 配置服务器URL（默认 http://localhost:8188）
   - 选择模型文件
   - 选择LoRA模型（可选）
   - 选择工作流模板
   - 调整采样参数、图像尺寸等
3. 测试连接确保服务正常
4. 保存配置

### 🤖 Agent调用（简化方式）

#### 基础调用（推荐）
Agent只需生成创意性的正面提示词：

```
<<<[TOOL_REQUEST]>>>
tool_name:「始」ComfyUIGen「末」,
prompt:「始」a serene landscape with cherry blossoms, soft morning light, photorealistic, highly detailed「末」
<<<[END_TOOL_REQUEST]>>>
```

#### 带负面提示词的调用
```
<<<[TOOL_REQUEST]>>>
tool_name:「始」ComfyUIGen「末」,
prompt:「始」a majestic castle on a hilltop, fantasy art style, golden hour lighting「末」,
negative_prompt:「始」blurry, low quality, distorted architecture「末」
<<<[END_TOOL_REQUEST]>>>
```

#### 指定工作流的调用
```
<<<[TOOL_REQUEST]>>>
tool_name:「始」ComfyUIGen「末」,
prompt:「始」portrait of a wise wizard, detailed facial features, magical atmosphere「末」,
workflow:「始」text2img_advanced「末」
<<<[END_TOOL_REQUEST]>>>
```

### 🎯 工作分工说明

| 角色 | 负责内容 | 示例 |
|------|----------|------|
| **Agent** | 创意性描述、艺术风格、场景构思 | "一个神秘的森林场景，阳光透过树叶洒下" |
| **用户配置** | 技术参数、质量控制、输出规格 | 模型选择、图像尺寸、采样步数、LoRA等 |
| **系统整合** | 参数合并、工作流执行、结果返回 | 自动处理，用户无感知 |

### 📝 Agent提示词编写建议

1. **专注描述内容**：详细描述想要的图像内容、风格、氛围
2. **避免技术参数**：不需要指定尺寸、步数、模型等技术细节
3. **使用艺术术语**：如"highly detailed"、"photorealistic"、"epic scene"等
4. **考虑光线构图**：描述光线效果、视角、构图等艺术要素

### 🔄 传统调用（向后兼容）
如需覆盖用户配置，仍可使用完整参数调用：

```
<<<[TOOL_REQUEST]>>>
tool_name:「始」ComfyUIGen「末」,
prompt:「始」a cute cat sitting on a windowsill, sunlight, photorealistic「末」,
negative_prompt:「始」low quality, blurry, distorted「末」,
width:「始」768「末」,
height:「始」512「末」,
steps:「始」25「末」,
cfg_scale:「始」7.5「末」,
seed:「始」12345「末」
<<<[END_TOOL_REQUEST]>>>
```

## 工作流模板

### 当前支持的模板

- `text2img_basic.json`: 基础文生图工作流

### 添加自定义工作流

1. 在ComfyUI中设计你的工作流
2. 导出为API格式(JSON)
3. 将文件保存到 `workflows/` 目录
4. 在调用时指定 `workflow` 参数

## 参数说明

| 参数 | 类型 | 必需 | 默认值 | 说明 |
|------|------|------|--------|------|
| prompt | string | 是 | - | 正面提示词 |
| negative_prompt | string | 否 | "text, watermark, low quality" | 负面提示词 |
| width | number | 否 | 1024 | 图像宽度 |
| height | number | 否 | 1024 | 图像高度 |
| steps | number | 否 | 20 | 采样步数 |
| cfg_scale | number | 否 | 7.0 | CFG引导强度 |
| seed | number | 否 | 随机 | 随机种子 |
| sampler_name | string | 否 | "euler" | 采样器 |
| scheduler | string | 否 | "normal" | 调度器 |
| workflow | string | 否 | "text2img_basic" | 工作流模板 |
| MODEL_NAME | string | 否 | "v1-5-pruned-emaonly.ckpt" | 模型文件名 |

## 故障排除

### Bug修复记录 (2025-01-30)

#### 第一阶段：IPC处理器注册问题
**问题**: ComfyUI功能无法正常工作 - 无法加载模型、无法保存设置、无法测试连接
- 错误信息: `Error: No handler registered for 'get-comfyui-models'`

**根本原因**: IPC handlers初始化参数传递错误，导致处理器链式初始化失败

**修复内容**:
1. **修复chatHandlers初始化** (`main.js:138-147`): 提供mainWindow和完整context
2. **修复groupChatHandlers初始化** (`main.js:158-164`): 提供mainWindow和context 
3. **修复diceHandlers初始化** (`main.js:197`): 提供projectRoot参数

**修复结果**: ✅ IPC处理器成功注册，后端连接正常

#### 第二阶段：架构独立性问题  
**问题**: ComfyUI使用了VCPChat的settings.json，违反独立配置原则

**根本原因**: 配置系统混杂，前端覆盖能力不足

**修复内容**:
- **独立配置系统重构** (`comfyuiHandlers.js`):
  - 创建独立的 `comfyui-settings.json` 配置文件
  - 实现config.env + 用户设置的优先级配置机制
  - 用户设置 > config.env > 系统默认值

**修复结果**: ✅ 配置系统独立，前端可完全覆盖后端设置

#### 第三阶段：网络连接兼容性问题
**问题**: Electron环境下axios请求持续502错误，影响模型获取

**根本原因**: Electron安全策略可能阻止HTTP请求

**修复内容**:
- **双重HTTP客户端策略** (`comfyuiHandlers.js`):
  ```javascript
  // 主要使用axios，失败时自动切换到原生HTTP
  try {
    const comfyuiAxios = await createComfyUIAxios();
    response = await comfyuiAxios.get('/object_info');
  } catch (axiosError) {
    response = await makeComfyUIRequest('/object_info');
  }
  ```

**修复结果**: ✅ 后端成功获取15个模型和77个LoRA

#### 第四阶段：前端显示功能缺失
**问题**: 后端数据获取成功，但前端无法显示模型列表，缺少LoRA界面

**根本原因**: 前端JavaScript功能不完整
- 缺少 `loadLorasBtn` 事件监听器
- 使用简单的 `prompt()` 对话框而非专业UI
- 前端试图调用不存在的 `getComfyUILoras()` IPC接口

**修复内容**:
1. **实现完整的前端交互** (`settingsManager.js`):
   - 添加LoRA按钮事件监听器
   - 创建专业的模态选择界面替换prompt对话框
   - 实现搜索和筛选功能

2. **优化数据流架构**:
   - 发现后端 `get-comfyui-models` 已同时返回models和loras数据
   - 实现前端缓存机制避免重复请求
   - 统一使用单一后端接口，前端分别处理models和loras数据

3. **增强配置管理**:
   - 添加LoRA配置字段支持
   - 实现配置变更时的缓存失效
   - 完善表单数据的加载和保存逻辑

**修复结果**: 
- ✅ 用户可通过专业模态界面选择15个模型
- ✅ 用户可通过专业模态界面选择77个LoRA  
- ✅ 支持搜索和实时筛选
- ✅ LoRA配置可正确保存和加载
- ✅ 前端界面响应流畅，用户体验优良

#### 第五阶段：架构解耦重构
**问题**: ComfyUI功能与VCPChat全局设置耦合，不符合模块化设计原则

**根本原因**: 功能集成在全局设置中，缺乏独立性和可维护性

**修复内容**:
1. **彻底移除全局设置集成**:
   - 从`main.html`中移除所有ComfyUI相关UI组件
   - 从`settingsManager.js`中清除所有ComfyUI相关代码
   - 确保全局设置完全不涉及ComfyUI功能

2. **创建独立模块架构**:
   - 建立`ComfyUImodules`目录结构
   - 实现完整的独立配置界面(`comfyui-settings.html`)
   - 开发专业的UI样式(`comfyui-settings.css`)
   - 编写完整的前端逻辑(`comfyui-settings.js`)

3. **实现窗口管理系统**:
   - 在`main.js`中添加独立的ComfyUI窗口管理器
   - 实现完整的窗口生命周期管理（创建、显示、关闭、内存清理）
   - 遵循VCP标准窗口管理模式

4. **建立完整IPC通信链**:
   - 在`preload.js`中添加`openComfyUIWindow`接口
   - 在`renderer.js`中实现按钮事件处理
   - 确保通信链完整：按钮→渲染进程→预加载→主进程→窗口创建

**修复结果**:
- ✅ ComfyUI功能完全从VCPChat全局设置中解耦
- ✅ 实现完整的独立模块架构，参照Notemodules设计模式
- ✅ 建立专业的独立配置界面，功能完整且用户友好
- ✅ 确保架构一致性，与其他VCP模块保持统一标准

#### 最终成果
**完整功能链路已打通**:
1. **独立模块架构**: 完全解耦，遵循VCP模块化标准
2. **后端数据获取**: 成功连接ComfyUI服务器，获取完整模型和LoRA列表
3. **前端界面展示**: 专业的独立配置界面，支持搜索和筛选
4. **配置管理系统**: 独立配置文件，支持前端完全覆盖后端设置  
5. **网络容错机制**: 双重HTTP客户端确保连接稳定性
6. **窗口生命周期**: 完善的窗口管理，内存安全

**当前状态**: ✅ 所有ComfyUI功能正常工作，架构完全解耦，模块独立运行

### 常见问题

1. **连接失败**: 检查COMFYUI_BASE_URL是否正确
2. **生成超时**: 增加队列检查次数或间隔
3. **模型未找到**: 确保ComfyUI中有对应的模型文件
4. **权限错误**: 检查COMFYUI_API_KEY配置
5. **配置无效**: 确保ComfyUI独立模块中的配置已正确保存

### 调试模式

在config.env中设置:
```
DEBUG_MODE=true
```

查看详细的调试信息来定位问题。

## 开发说明

### 工作流更新逻辑

插件会自动识别并更新工作流中的关键节点：

- **CLIPTextEncode**: 更新提示词
- **KSampler**: 更新采样参数
- **EmptyLatentImage**: 更新图像尺寸

### 前端开发

**关键文件**:
- `ComfyUImodules/comfyui-settings.html`: 独立UI界面定义
- `ComfyUImodules/comfyui-settings.js`: 独立前端逻辑处理
- `ComfyUImodules/comfyui-settings.css`: 专业UI样式
- `modules/ipc/comfyuiHandlers.js`: 后端IPC处理器
- `preload.js`: IPC接口定义
- `main.js`: 主程序集成和窗口管理

**开发注意事项**:
- 所有配置数据存储在独立的 `comfyui-settings.json` 文件中
- 采用独立窗口设计，完全解耦于VCPChat核心功能
- 遵循VCP模块化架构标准，参照Notemodules设计模式
- 错误处理采用toast通知方式，用户友好
- 支持实时连接测试和模型列表更新
- 实现了前端缓存机制，提升用户体验
- 窗口生命周期管理完善（创建、显示、关闭、内存清理）

### 扩展功能

可以通过修改 `updateWorkflowWithParams` 函数来支持更多节点类型和参数。

## 更新日志

### 2025-01-30 v0.3.0 - 架构解耦重构 🎉
- 🏗️ **完成VCPChat架构解耦**: 将ComfyUI功能从全局设置完全解耦为独立模块
- 📦 **独立模块实现**: 创建ComfyUImodules目录，实现完整的独立配置界面
- 🔧 **窗口管理系统**: 实现独立窗口生命周期管理，参照Notemodules设计模式
- 🎨 **UI集成优化**: 在主界面添加ComfyUI按钮，与其他模块保持一致的设计风格
- ⚙️ **IPC架构完善**: 建立完整的IPC通信链：按钮点击 → 渲染进程 → 预加载 → 主进程 → 窗口创建
- 📋 **配置系统独立**: 完全脱离VCPChat的settings.json，使用独立的配置管理
- 🧩 **模块化标准**: 严格遵循VCP模块化架构标准，确保架构一致性

### 2025-01-30 v0.2.0 - 重大架构升级 🎉
- 🚀 **完成前后端配置链路集成**: 全面打通VCPChat前端配置到ComfyUIGen后端的数据流
- 🎨 **优化Agent-ComfyUI协作模式**: Agent专注创意，用户配置技术参数，后端自动整合
- 🔧 **前端界面全面优化**:
  - 测试连接按钮移至服务器地址配置后，改善交互体验
  - 添加工作流选择下拉菜单，支持动态加载和刷新
  - 完善模型和LoRA选择界面，支持搜索和筛选
- 🏗️ **后端配置系统重构**:
  - 实现配置优先级：Agent参数 > 用户配置 > 环境变量 > 默认值
  - 集成placeholder-processor.js，使用占位符驱动的工作流更新
  - 建立统一的参数验证和转换系统
- 🎯 **LoRA功能完整实现**:
  - 默认工作流支持LoRA加载节点
  - 前端LoRA选择界面与后端完全打通
  - LoRA强度参数可配置（默认1.0）
- 📋 **工作流管理系统**:
  - 动态扫描workflows目录，自动发现工作流模板
  - IPC接口支持工作流列表刷新
  - 支持自定义工作流上传
- 📝 **文档和清单更新**:
  - plugin-manifest.json升级到v0.2.0，优化工具描述
  - README.md全面更新，明确Agent调用方式和工作分工
  - 添加Agent提示词编写建议和最佳实践

### 2025-01-30 v0.1.1 - 重大Bug修复
- 🐛 **修复ComfyUI功能无法使用的问题**  
  - **第一阶段**: 修复IPC handlers初始化参数传递错误
  - **第二阶段**: 重构独立配置系统，避免与VCPChat设置混杂
  - **第三阶段**: 实现双重HTTP客户端解决Electron网络兼容性问题
  - **第四阶段**: 完善前端JavaScript功能，实现专业的模型/LoRA选择界面
  - 最终结果: 成功连接ComfyUI服务器，获取15个模型和77个LoRA，前端界面完全可用

### 2025-01-29 v0.1.0 - 初始版本
- ✅ 完成VCPChat前端界面集成
- ✅ 实现完整的参数配置系统
- ✅ 添加后端IPC处理器
- ✅ 集成连接测试和模型加载功能
- ✅ 建立前后端完整的数据流